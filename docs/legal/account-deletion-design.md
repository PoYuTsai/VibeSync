# 帳號刪除功能設計

> **App Store 要求**：所有支援帳號建立的 App 必須提供帳號刪除功能
> **Google Play 要求**：同上，且必須在 App 內可完成

---

## 1. 刪除流程

### 1.1 用戶操作流程

```
設定 → 帳號 → 刪除帳號 → 確認頁面 → 輸入密碼/重新驗證 → 最終確認 → 完成
```

### 1.2 詳細步驟

```
┌─────────────────────────────────────────┐
│  設定                                   │
├─────────────────────────────────────────┤
│  👤 帳號資訊                       >    │
│  🔔 通知設定                       >    │
│  🔒 隱私設定                       >    │
│  ❓ 幫助中心                       >    │
│  ────────────────────────────────────── │
│  🗑️ 刪除帳號                       >    │ ← 明顯可見
└─────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│  刪除帳號                               │
├─────────────────────────────────────────┤
│                                         │
│  ⚠️ 刪除帳號將會：                      │
│                                         │
│  • 永久刪除您的帳號資料                 │
│  • 刪除所有本地儲存的對話               │
│  • 取消目前的訂閱（不退款）             │
│  • 無法復原                             │
│                                         │
│  ────────────────────────────────────── │
│                                         │
│  如果您只是想暫停使用，可以：           │
│  [取消訂閱] 保留帳號但停止付費          │
│                                         │
│  ────────────────────────────────────── │
│                                         │
│  [取消]        [我要刪除帳號]           │
│                                         │
└─────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│  確認身份                               │
├─────────────────────────────────────────┤
│                                         │
│  為確保是您本人操作，請重新驗證：       │
│                                         │
│  [使用 Google 登入驗證]                 │
│  [使用 Apple 登入驗證]                  │
│  [輸入密碼驗證]                         │
│                                         │
└─────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│  最終確認                               │
├─────────────────────────────────────────┤
│                                         │
│  請輸入「刪除我的帳號」以確認：         │
│                                         │
│  ┌─────────────────────────────────┐    │
│  │                                 │    │
│  └─────────────────────────────────┘    │
│                                         │
│  [取消]           [永久刪除]            │
│                  (紅色按鈕)             │
│                                         │
└─────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│  刪除中...                              │
├─────────────────────────────────────────┤
│                                         │
│         ⏳                              │
│                                         │
│  正在刪除您的帳號...                    │
│  這可能需要幾秒鐘                       │
│                                         │
└─────────────────────────────────────────┘
          │
          ▼
┌─────────────────────────────────────────┐
│  帳號已排程刪除                         │
├─────────────────────────────────────────┤
│                                         │
│         ✓                               │
│                                         │
│  您的帳號已排程刪除                     │
│                                         │
│  • 帳號將在 24 小時內停用               │
│  • 所有資料將在 30 天內永久刪除         │
│  • 您將收到確認 Email                   │
│                                         │
│  如有疑問，請聯繫 support@vibesync.app  │
│                                         │
│  [知道了，登出]                         │
│                                         │
└─────────────────────────────────────────┘
```

---

## 2. 技術實作

### 2.1 刪除時程

| 階段 | 時間 | 動作 |
|------|------|------|
| 請求刪除 | T+0 | 標記帳號為 `pending_deletion` |
| 停用帳號 | T+24h | 帳號無法登入，標記為 `disabled` |
| 資料刪除 | T+30d | 永久刪除所有資料 |

### 2.2 30 天緩衝期原因

- 防止誤刪或被盜帳號惡意刪除
- 給用戶後悔的機會
- 符合多數平台的最佳實踐

### 2.3 資料刪除範圍

| 資料類型 | 位置 | 刪除方式 |
|----------|------|----------|
| 帳號資料 | Supabase | 硬刪除 |
| 用量紀錄 | Supabase | 匿名化保留 |
| 訂閱資料 | RevenueCat | 標記刪除 |
| 本地資料 | 裝置 | App 內清除 |

### 2.4 資料庫設計

```sql
-- 帳號狀態欄位
ALTER TABLE users ADD COLUMN status VARCHAR(20) DEFAULT 'active';
-- active | pending_deletion | disabled | deleted

-- 刪除時間欄位
ALTER TABLE users ADD COLUMN deletion_requested_at TIMESTAMP;
ALTER TABLE users ADD COLUMN deletion_scheduled_at TIMESTAMP;

-- 刪除原因 (可選，用於分析)
ALTER TABLE users ADD COLUMN deletion_reason VARCHAR(100);
```

### 2.5 API 端點

```typescript
// POST /api/account/request-deletion
// 請求刪除帳號
{
  "confirmation": "刪除我的帳號",
  "reason": "不再使用" // 可選
}

// Response
{
  "success": true,
  "deletion_scheduled_at": "2026-03-28T00:00:00Z",
  "message": "帳號將在 30 天後永久刪除"
}

// POST /api/account/cancel-deletion
// 取消刪除 (在 30 天內)
{
  "confirmation": true
}
```

### 2.6 後端排程任務

```typescript
// 每日執行：處理待刪除帳號
async function processPendingDeletions() {
  // 1. 停用超過 24 小時的待刪除帳號
  await db.query(`
    UPDATE users
    SET status = 'disabled'
    WHERE status = 'pending_deletion'
    AND deletion_requested_at < NOW() - INTERVAL '24 hours'
  `);

  // 2. 永久刪除超過 30 天的帳號
  const toDelete = await db.query(`
    SELECT id FROM users
    WHERE status = 'disabled'
    AND deletion_requested_at < NOW() - INTERVAL '30 days'
  `);

  for (const user of toDelete) {
    await permanentlyDeleteUser(user.id);
  }
}

async function permanentlyDeleteUser(userId: string) {
  // 1. 刪除相關資料
  await db.query('DELETE FROM conversations WHERE user_id = $1', [userId]);
  await db.query('DELETE FROM usage_logs WHERE user_id = $1', [userId]);

  // 2. 通知 RevenueCat 刪除
  await revenueCat.deleteUser(userId);

  // 3. 刪除用戶記錄
  await db.query('DELETE FROM users WHERE id = $1', [userId]);

  // 4. 記錄刪除事件 (匿名)
  await db.query(`
    INSERT INTO deletion_logs (deleted_at, reason)
    VALUES (NOW(), $1)
  `, [anonymizedReason]);
}
```

---

## 3. 訂閱處理

### 3.1 有效訂閱的處理

```
┌─────────────────────────────────────────┐
│  您有有效的訂閱                         │
├─────────────────────────────────────────┤
│                                         │
│  ⚠️ 您目前有有效的訂閱：                │
│                                         │
│  方案：Essential                        │
│  到期日：2026-04-15                     │
│                                         │
│  刪除帳號後：                           │
│  • 訂閱將自動取消，不會再扣款           │
│  • 已付費用不予退還                     │
│  • 您可使用至原到期日                   │
│                                         │
│  [返回]        [了解，繼續刪除]         │
│                                         │
└─────────────────────────────────────────┘
```

### 3.2 退款政策

- 訂閱費用不退還（Apple/Google 政策）
- 特殊情況可聯繫客服協助處理
- 在刪除確認頁面明確說明

---

## 4. 復原機制

### 4.1 30 天內復原

```
// 用戶嘗試登入已排程刪除的帳號
┌─────────────────────────────────────────┐
│  帳號待刪除                             │
├─────────────────────────────────────────┤
│                                         │
│  此帳號已排程刪除                       │
│                                         │
│  刪除時間：2026-03-28                   │
│  剩餘天數：25 天                        │
│                                         │
│  您可以取消刪除並恢復帳號：             │
│                                         │
│  [取消刪除，恢復帳號]                   │
│                                         │
│  或繼續等待帳號刪除。                   │
│                                         │
└─────────────────────────────────────────┘
```

### 4.2 30 天後

- 無法復原
- 用戶需重新註冊
- 所有歷史資料已永久刪除

---

## 5. 通知機制

### 5.1 刪除請求確認 Email

```
主旨：VibeSync 帳號刪除確認

親愛的用戶，

我們已收到您的帳號刪除請求。

• 帳號將在 24 小時內停用
• 所有資料將在 30 天內永久刪除

如果這不是您本人的操作，請立即聯繫我們：
support@vibesync.app

如需取消刪除，請在 30 天內登入 App 並選擇「取消刪除」。

VibeSync 團隊
```

### 5.2 刪除完成通知

```
主旨：VibeSync 帳號已刪除

您的 VibeSync 帳號已永久刪除。

所有相關資料已從我們的系統中移除。

感謝您曾使用 VibeSync。

如有任何疑問，請聯繫 support@vibesync.app

VibeSync 團隊
```

---

## 6. App Store 合規檢查清單

### iOS (App Store)

- [x] 刪除功能在 App 內可見且易於找到
- [x] 不需要聯繫客服或訪問網站
- [x] 清楚說明刪除的後果
- [x] 提供確認步驟防止誤刪
- [x] 刪除後確實移除用戶資料

### Android (Google Play)

- [x] 提供 App 內刪除選項
- [x] 同時提供網頁版刪除選項（可選）
- [x] 在隱私政策中說明刪除流程
- [x] 在 Google Play Console 填寫資料刪除表單

---

## 7. 測試案例

| 案例 | 預期結果 |
|------|----------|
| 普通用戶刪除 | 30 天後完全刪除 |
| 有訂閱用戶刪除 | 訂閱取消，用到期日 |
| 刪除後 25 天內恢復 | 可成功恢復 |
| 刪除後 31 天嘗試登入 | 顯示「帳號不存在」 |
| 同 Email 重新註冊 | 可成功建立新帳號 |
