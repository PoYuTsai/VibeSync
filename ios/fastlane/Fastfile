# ios/fastlane/Fastfile
# Fastlane configuration for iOS deployment

default_platform(:ios)

platform :ios do
  desc "Push a new build to TestFlight"
  lane :beta do
    # Ensure we have latest code
    ensure_git_status_clean(
      show_diff: true
    )

    # Increment build number
    increment_build_number(
      build_number: ENV["GITHUB_RUN_NUMBER"] || Time.now.to_i.to_s
    )

    # Build the app
    build_app(
      scheme: "Runner",
      workspace: "Runner.xcworkspace",
      export_method: "app-store",
      export_options: {
        provisioningProfiles: {
          "com.vibesync.app" => "VibeSync AppStore"
        }
      },
      output_directory: "./build",
      output_name: "VibeSync.ipa"
    )

    # Upload to TestFlight
    upload_to_testflight(
      skip_waiting_for_build_processing: true,
      api_key: app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY"]
      )
    )

    # Notify via Slack if webhook URL is set
    if ENV["SLACK_WEBHOOK_URL"]
      slack(
        message: "VibeSync iOS build uploaded to TestFlight! ðŸš€",
        slack_url: ENV["SLACK_WEBHOOK_URL"],
        default_payloads: [:git_branch, :last_git_commit_message]
      )
    end
  end

  desc "Build for local testing"
  lane :build do
    build_app(
      scheme: "Runner",
      workspace: "Runner.xcworkspace",
      export_method: "development",
      output_directory: "./build"
    )
  end
end
