# .github/workflows/release.yml
# Release to App Stores (TestFlight + Internal Testing)
# Manual trigger only - for production releases

name: Release to App Stores

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to release'
        required: true
        default: 'both'
        type: choice
        options:
          - ios
          - android
          - both

env:
  FLUTTER_VERSION: '3.29.0'

jobs:
  release-ios:
    if: inputs.platform == 'ios' || inputs.platform == 'both'
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ios

      - name: Install Fastlane
        run: |
          cd ios
          gem install fastlane

      - name: Setup iOS certificates
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_P12_CERTIFICATE }}
          p12-password: ${{ secrets.IOS_P12_PASSWORD }}

      - name: Build iOS (Production)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_PROD_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_PROD_ANON_KEY }}
          REVENUECAT_KEY: ${{ secrets.REVENUECAT_PROD_KEY }}
        run: |
          flutter build ipa --release \
            --dart-define=ENV=prod \
            --dart-define=SUPABASE_PROD_URL="$SUPABASE_URL" \
            --dart-define=SUPABASE_PROD_ANON_KEY="$SUPABASE_KEY" \
            --dart-define=REVENUECAT_PROD_KEY="$REVENUECAT_KEY" \
            --export-options-plist=ios/ExportOptions.plist

      - name: Upload to TestFlight
        env:
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: cd ios && fastlane beta

  release-android:
    if: inputs.platform == 'android' || inputs.platform == 'both'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests
        run: flutter test

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: android

      - name: Install Fastlane
        run: |
          cd android
          gem install fastlane

      - name: Setup Android signing
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/app/keystore.jks
          echo "storeFile=keystore.jks" >> android/key.properties
          echo "storePassword=$KEYSTORE_PASSWORD" >> android/key.properties
          echo "keyAlias=$KEY_ALIAS" >> android/key.properties
          echo "keyPassword=$KEY_PASSWORD" >> android/key.properties

      - name: Build Android (Production)
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_PROD_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_PROD_ANON_KEY }}
          REVENUECAT_KEY: ${{ secrets.REVENUECAT_PROD_KEY }}
        run: |
          flutter build appbundle --release \
            --dart-define=ENV=prod \
            --dart-define=SUPABASE_PROD_URL="$SUPABASE_URL" \
            --dart-define=SUPABASE_PROD_ANON_KEY="$SUPABASE_KEY" \
            --dart-define=REVENUECAT_PROD_KEY="$REVENUECAT_KEY"

      - name: Upload to Play Store (Internal)
        env:
          PLAY_STORE_CONFIG_JSON: ${{ secrets.PLAY_STORE_CONFIG_JSON }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: cd android && fastlane internal
